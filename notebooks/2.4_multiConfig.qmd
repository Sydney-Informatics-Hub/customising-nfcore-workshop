---
title: "**2.4. Using multiple configuration files at once**"
output:
  html_document:
    toc: false
    toc_float: false
from: markdown+emoji
---

::: callout-tip
### Objectives{.unlisted}
- Create and apply custom configuration files for:
  - Specifying a non-default tool container
  - Customised resource tracing
  - Bespoke MultiQC report formatting
  - Adding tool arguments that are not available as nf-core parameters
- Apply multiple custom configuration files in a single workflow execution with `-c <conf-1,conf2,...>` 
:::


Using multiple configuration files allows you to customise nf-core pipelines to your specific needs. 

Depending on how you work, where you work, and what pipelines you run, you may have configuration files that:


- Handle distinct issues
- Can be applied to specific infrastructures
- Can be shared by multiple nf-core pipelines

In this lesson we will create four custom configuration files that affect different aspects of the workflow and apply them to the one run command.
<br/><br/>

### **2.4.1. Configure your run to use a non-default container**

::: callout-important
### 
Note that for deploying nf-core workflows, it is not recommended to replace the tools within the workflow, as this will decrease portability and reproducibilty! This exercise is to demonstrate how you can specify containers, as this may aid you in developing and testing your own Nextflow workflows
:::

For this example, we are going to test out the latest version of [Trim Galore](https://github.com/FelixKrueger/TrimGalore). We have been using the default version of Trim Galore that is executed with nf-core/rnaseq revision 3.11.1. 

We can easily view the versions of all tools used from the `software_versions.yml` file created by default in the `<outdir>/pipeline_info` directory by nf-core workflows *OR* by viewing the same information from the 'nf-core/rnaseq Software Versions' section of the MultiQC html report.  
<br/>

&#x27A4; Identify the version of Trim Galore that has been used in our runs so far from the `software_versions.yml` file: 

- You might view the file by opening it from the VS Code explorer pane, using `more` command, or `grep` for the tool name

```default
more Lesson-2.3.4/pipeline_info/software_versions.yml

##
#TRIMGALORE:
#  cutadapt: '3.4'
#  trimgalore: 0.6.7
#
```

The module names are listed in alphabetical order, with the tools and versions used in the `script` section of the process listed below each module. We can see TRIMGALORE that version 0.6.7 of Trim Galore was used. 
<br/><br/>

There is a [newer version of Trim Galore](https://github.com/FelixKrueger/TrimGalore/releases/tag/0.6.10) available, version 0.6.10. Recall that we have been accessing some materials on [**CernVM-FS**](https://support.pawsey.org.au/documentation/pages/viewpage.action?pageId=92832676#NimbusforBioinformatics-1.BiocontainersandReferenceGenomedataÂ ), a read-only filesystem which provides shared access to common bioinformatics reference datasets as well as Singularity containers of everything stored in [Biocontainers](https://biocontainers.pro/).

CernVM-FS comes pre-mounted on Pawsey Nimbus VMs using the [**Pawsey Bio - Ubuntu 22.04 - 2023-03**](https://support.pawsey.org.au/documentation/display/US/Nimbus+for+Bioinformatics#) image, so we can access and apply the Trim Galore biocontainer by specifying the path to this remote image within the `process` scope of a custom config, using the `'withName'` process selector. 

We could just as easily specify an alternate remote source, such as [quay.io](https://quay.io/organization/biocontainer), or point to a local image. 

<br/>

::: callout-tip
### **Thoughts**{.unlisted}
:question: For maintaining best practice, where is the best place to specify our custom container?

a) Within the `custom-nimbus.config` institutional config file

b) Within a separate custom config file named eg `custom-tools.config`

Why do you think this? 
:::

::: {.callout-caution collapse="true"}
### Solution
Remember, Nextflow's portability is achieved by separating **workflow implementation** from the **configuration settings** required to execute it. In the event that we are testing a different tool version, this should **not** be placed within the institutional config that is shareable with others using the same infrastructure. Swapping out tool versions is a bespoke adaptation of the nf-core workflow that could harm reproducibility if it was inadvertently executed. By placing it within a clearly named custom config file, there is less chance of unwittingly executing a workflow that does not match the expected utilisation of tools. 
:::
<br/> 


&#x27A4; First, identify the container for the 0.6.10 version of Trim Galore:

::: callout-note
###
Containers are mounted at the path `/cvmfs/singularity.galaxyproject.org`, with sub-directories based on the first 2 letters of the tool name, eg `/cvmfs/singularity.galaxyproject.org/t/r/` for Trim Galore containers. 
:::

``` default
ls /cvmfs/singularity.galaxyproject.org/t/r/trim*

##
#  /cvmfs/singularity.galaxyproject.org/t/r/trim-galore:0.6.10--hdfd78af_0
##
```
<br/>

&#x27A4; Next, identify the execution path for the TRIMGALORE module: 

``` default
grep -i galore nf-core-rnaseq-3.11.1/workflow/conf/modules.config 

##
#    if (params.trimmer == 'trimgalore') {
#            withName: '.*:FASTQ_FASTQC_UMITOOLS_TRIMGALORE:FASTQC' {
#    if (params.trimmer == 'trimgalore') {
#            withName: '.*:FASTQ_FASTQC_UMITOOLS_TRIMGALORE:TRIMGALORE' {
#                        params.extra_trimgalore_args ? params.extra_trimgalore_args.split("\\s(?=--)") : ''
##
```
<br/>

&#x27A4; Open a file for editing named  `custom-tools.config`, and start building your config with the `process` scope and `'withName'` selector that we covered in
[Lesson 2.3.5](2.3_configEnv.html#custom-resource-configuration-using-process-names):

```default
process {
  withName: {

  }
}
```
<br/>

&#x27A4; Then copy the Trim Galore module execution path from your terminal inside the `process` block:

``` default
process {
  withName: '.*:FASTQ_FASTQC_UMITOOLS_TRIMGALORE:TRIMGALORE' {

  }
}
```
<br/>

&#x27A4; Finally, copy the container details from your terminal inside the `withName` block:

``` default
process {
  withName: '.*:FASTQ_FASTQC_UMITOOLS_TRIMGALORE:TRIMGALORE' {
    container = '/cvmfs/singularity.galaxyproject.org/t/r/trim-galore:0.6.10--hdfd78af_0' 
  }
}
```
<br/>

&#x27A4; Save `custom-tools.config` then resume the previous run, supplying our two configuration files at `-c`:

::: callout-note
### Specify multiple configs
When adding multiple custom configs, we apply them to `-c` in a **comma-delimited list**
:::

- First, delete or comment out the `withName` block we applied in the `custom-nimbus.config` file
  - In Nextflow, use `//` for single line comments or  `/* .. */` to comment a block on multiple lines
- Specify output directory `Lesson-2.4.1` 

``` default
 nextflow run nf-core-rnaseq-3.11.1/workflow/main.nf \
  -profile workshop \
  -c custom-nimbus.config,custom-tools.config \
  -params-file workshop-params.yaml \
  --outdir Lesson-2.4.1 \
  -resume 
```
<br/>

&#x27A4; After your run has completed, check that the updated version of Trim Galore has been used:

```default
grep -i galore Lesson-2.4.1/pipeline_info/software_versions.yml

##
#TRIMGALORE:
#  trimgalore: 0.6.10
##
```
<br/><br/>


### **2.4.2. Customised resource tracing**

Running Nextflow workflows with the option `-with-trace` writes a [trace report](https://www.nextflow.io/docs/latest/tracing.html#trace-report) named `trace.txt` in the working directory.

nf-core pipelines by default create an `execution_trace` file within `<outdir>/pipeline_info`, with the default fields that Nextflow `-with-trace` applies. A trace report can be customised to include any combination of [available fields](https://www.nextflow.io/docs/latest/tracing.html#trace-fields)  using the Nextflow `-fields` flag.

In this exercise, we will create a custom configuration file that writes a detailed resource tracing file including our chosen fields. 

To begin, we will extract these custom fields from a previous run using the `nextflow log` command.  


::: callout-tip
### **Challenge**{.unlisted}

Using the [trace report fields](https://www.nextflow.io/docs/latest/tracing.html#trace-fields), write a `nextflow log` command to query the following for a previous workflow run:

- Task **name**
- Task **status**
- Task **exit** status 
- Task execution time (**realtime**)
- Number of **cpus** requested for the task
- Percentage of CPU used by the process ([use **pcpu** rather than **%cpu**](https://github.com/nextflow-io/nextflow/issues/3893#event-9076291921))
- Amount of **memory** requested for the task 
- Percentage of memory used by the process ([use **pmem** rather than **%mem**](https://github.com/nextflow-io/nextflow/issues/3893#event-9076291921))
- Resident set size of the process (**rss**)

:::

::: {.callout-caution collapse="true"}
### Solution

First, run `nextflow log` with no arguments to obtain the name of your last run (unless you can remember it!)

Then, supply that run name to the command below:

```default
nextflow log <run_name> -f name,status,exit,realtime,cpus,pcpu,memory,pmem,rss
```
:::
<br/>

If there is a specific combination of fields you would like to regularly capture for your pipeline runs, perhaps for [resource benchmarking](https://www.nature.com/articles/s41467-019-09406-4), it would be useful to have a custom configuration file that can be optionally applied to any run. 

Let's make a portable configuration file for resource tracing. Because this config is not infrastructure or pipeline specific, we can share it with collaborators and use it across multiple pipelines. 
<br/><br/>

&#x27A4;  Open a file for editing called `custom-trace.config` and add the following content:

::: callout-note
###
Note that we need to use `%cpu` and `%mem`, as per the [Nextflow documentation](https://www.nextflow.io/docs/latest/tracing.html#trace-fields), and not `pcpu` and `pmem` as we applied on the command line due to this [issue](https://github.com/nextflow-io/nextflow/issues/3893#event-9076291921)
:::

```default
// Define timestamp, to avoid overwriting existing trace 
def trace_timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')

// Generate custom resource trace file 
trace {
  enabled = true 
  file = "${params.outdir}/custom-resource-trace-${trace_timestamp}.txt"
  fields = 'name,status,exit,realtime,cpus,%cpu,memory,%mem,rss'
}
```
<br/>

&#x27A4;  Resume your previous run, adding `custom-trace.config` and specifying output directory Lesson-2.4.2:

```default
nextflow run nf-core-rnaseq-3.11.1/workflow/main.nf \
  -profile workshop \
  -c custom-nimbus.config,custom-tools.config,custom-trace.config \
  -params-file workshop-params.yaml \
  --outdir Lesson-2.4.2 \
  -resume 
```
<br/>

:eyes: Notice that your multiple custom configurations are listed under **Core Nextflow options** on the launch log printed to the screen:
<br/><br/>
![](../figs/2.4_screenshot_config_list.png)
<br/><br/>

&#x27A4;  Once the workflow has run, take a look at the `Lesson-2.4.2/custom-resource-trace-${trace_timestamp}.txt` file:

![](../figs/2.4_screenshot_custom_trace.png)
<br/><br/>


### **2.4.3. Configure MultiQC reports**

Many nf-core pipelines use [MultiQC](https://multiqc.info/docs/) to generate a summary report at the end of a workflow. MultiQC is a reporting tool that can aggregate results and statistics output by various bioinformatics tools, helping to summarise experiments containing multiple samples and multiple analysis steps. 

MultiQC allows users the flexibility of [customising the output reports](https://multiqc.info/docs/reports/customisation/). 

nf-core has enabled users to take full advantage of this functionality through the inclusion of the [`--multiqc_config` parameter](https://nf-co.re/rnaseq/3.11.1/parameters#multiqc_config).

::: {.callout-important}
### Hidden nf-core parameters
The `--multiqc_config` parameter is a **'hidden param'!** To see this parameter, you need to apply `--show_hidden_params` on the command line help, or select **'Show hidden params'** on the nf-core parameters webpage 
:::
<br/>


We are going to configure MultiQC to:

- Aid interpretation of the FastQC "Per Sequence GC Content" plot by overlaying a [theoretical GC content track](https://multiqc.info/modules/fastqc/#theoretical-gc-content) specific for our mm10 reference genome
- Add a custom report header 
<br/><br/>

&#x27A4;  Open a file for editing named `custom-multiqc-config.yaml` and add the following content:

::: {.callout-note}
### Tip
You can add any fields under the `report_header_info` section, as long as you follow the required formatting
:::

```default
# Project level information:
report_header_info:
  - Contact E-mail: "cali.willet@sydney.edu.au"
  - Workshop host: "Australian BioCommons"
  - Workshop title: "Unlocking nf-core - customising workflows for your research"
  - Workshop URL: https://sydney-informatics-hub.github.io/customising-nfcore-workshop/
  - Sample data: Mouse RNAseq from https://bmcgenomics.biomedcentral.com/articles/10.1186/s12864-016-2801-4 

# Theoretical GC Content:
fastqc_config:  
  fastqc_theoretical_gc: "mm10_txome" 
```
<br/>

&#x27A4; To the `workshop-params.yaml` file, add:

```default
multiqc_config: "custom-multiqc-config.yaml" 
```
<br/>

&#x27A4; Make sure both YAML files are saved, then re-run the workflow:

::: {.callout-note}
We do not need to add our MultiQC config at the Nextflow option `-c` because we have specified it as an nf-core parameter within `workshop-params.yaml`
:::

```default
nextflow run nf-core-rnaseq-3.11.1/workflow/main.nf \
  -profile workshop \
  -c custom-nimbus.config,,custom-tools.config,custom-trace.config \
  -params-file workshop-params.yaml \
  --outdir Lesson-2.4.3 \
  -resume
```
<br/>

&#x27A4; View the html file `Lesson-2.4.2/multiqc/star_salmon/multiqc_report.html` and compare it to the report generated by a previous run:

::: {.callout-note}
### Viewing HTML
- If you are using VS Code with the 'Live Server' extension installed, right click the html file in the Explorer pane and select 'Open with Live Server'
- If you are using a terminal without a browser GUI enabled, use eg `scp` command to take a copy to your local computer and open in your preferred browser 
:::

Navigate to the section titled **FastQC: Per Sequence GC Content**. Compare the two plots to observe the custom track has been successfully added. 

![](../figs/2.4_MultiQC.png)
<br/>

:eyes: This track has shown that our sample transcriptomes follow a normal distribution consistent with the mm10 reference. 
<br/><br/>

::: callout-tip
### **Challenge**{.unlisted}
If we did detect GC bias, how could we customise our run to correct for this?
:::

::: {.callout-caution collapse="true"}
### Solution
This is a tricky one, particularly if you are unfamiliar with RNAseq analysis! 

1. Correcting for GC bias in this analysis requires operation at the transcript quantification step, which is performed by the `SALMON_QUANT` module
2. Reading the tool documentation for `salmon` indicates we need to apply the [`--gcBias`](https://salmon.readthedocs.io/en/latest/salmon.html#gcbias) flag
3. Checking the available nf-core [parameters for the rnaseq pipeline](https://nf-co.re/rnaseq/3.11.1/parameters), we find that there is no nf-core parameter addressing GC bias!
4. However, the astute observer would discover a parameter `--extra_salmon_quant_args` with description *'Extra arguments to pass to Salmon quant command in addition to defaults defined by the pipeline'*. Sounds perfect, yes?!
5. We can then provide the required `salmon` flag (and any others we needed) as an argument to the nf-core `--extra_salmon_quant_args` parameter, wrapped in quotes, supplying the parameter to the run as we would any other nf-core parameter (either on the command line or within a parameters file):

```default
# Within parameters YAML file:
extra_salmon_quant_args : '--gcBias'

# On the command line - note the intentional inclusion of whitespace inside the quotes:
--extra_salmon_quant_args '--gcBias '
```
:::
<br/><br/>

:scream: <span style="color:#8b0000;">**What would we do if the above solution was not available within our chosen nf-core pipeline?**</span>

 We will cover this in the next lesson! :sunglasses:

<br/>

### **2.4.4. Apply external arguments**

All nf-core modules are currently required to include the mandatory arguments that a tool needs to run within the `main.nf` file of the process running that tool. 

Optional arguments for a tool that are commonly changed are usually included as nf-core workflow parameters, so they can be easily customised on the command line or supplied within a parameters file. 

As we are all aware, bioinformatics tools can have a *lot* of optional arguments. It is not feasible for nf-core to paramaterise all of these arguments...

![](../figs/2.4_args_pie_chart.png){width=50%}

<br/>


In this lesson, we will learn how to apply any argument for a tool that is not explicitly covered by an nf-core workflow parameter using Nextflow's [`ext` directive](https://www.nextflow.io/docs/latest/process.html#ext).
<br/><br/>

&#x27A4; Consider the diagram below:


- On the **left** of the diagram is an example of the standard `main.nf` format of a process named `example` stored in the `modules` directory
  - Above the script block, the `$args` variable is defined
  - The `task.ext.args ?: ''` expression checks if the `ext.args` parameter has already been defined
  - If it isn't defined it will assign an empty string 
  - Inside the script block, the `$args` variable is applied to the tool command
- In the **middle** of the diagram is a custom configuration file targeting the 'EXAMPLE' process
  - This configuration file gives the tool-specific argument `--flag1` to `ext.args` using `withName`
- On the **right** of the diagram we see how the tool command is executed if `-c example-custom.config` was applied to the run
  - The `$args` variable is interpolated to `--flag1` when `modules/example/main.nf` is executed
<br/><br/>

![](../figs/2.5_ext-args.png)
<br/><br/><br/>

To practice this, we are going to pass an optional flag to the Trim Galore process. 

::: {.callout-important}
###
This workshop was developed *before* the release of `nf-core/rnaseq -r 3.11.0`, where the parameter [`--extra_trimgalore_args`](https://nf-co.re/rnaseq/3.11.1/parameters#extra_trimgalore_args) was first introduced. 

We have retained this exercise as it is equally applicable to other tools which do not have an `--extra_<tool>_args` nf-core parameter. 

This is a good reminder that:

- nf-core pipelines are under active development
- carefully check the parameter and usage docs with each new release
- submit feature requests to the nf-core/github pipeline repo to have `--extra_<tool>_args` added where you think it's warranted
:::
<br/><br/>

For the sake of the lesson, let's assume we want to apply a very stringent minimum Phred score of 40. 

:exclamation: *This is overly stringent! Bear with us...* :blush:
<br/><br/>

&#x27A4;  Follow the decision tree to work out how to apply this workflow customisation. Some useful links are below the flowchart:




![](../figs/2.4_trimgalore_qual_decision_chart.png)
<br/><br/>

:toolbox: [Trim Galore docs](https://github.com/FelixKrueger/TrimGalore/blob/master/Docs/Trim_Galore_User_Guide.md#general-options)

:toolbox: [nf-core/rnaseq trimming params](https://nf-co.re/rnaseq/3.11.1/parameters#read-trimming-options)

:toolbox: [Trim Galore `main.nf`](https://github.com/nf-core/rnaseq/blob/3.11.1/modules/nf-core/trimgalore/main.nf)

<br/><br/>


::: {.callout-note}
### Inclusion of ext.args
Recall from [Lesson 2.1.2](2.1_design.html#design-your-run-command) that the inclusion of `ext.args` is currently standard practice for all DSL2 nf-core modules where additional parameters may be required to run a process, however this *may not be implemented for all processes*
:::

From the above investigation, we have learnt that:

- The Trim Galore argument `--quality 40` is required to over-ride the Trim Galore default of 20

- This parameter is absent from the nf-core/rnaseq parameters list 
  - *Remember to kindly ignore the `--extra_trimgalore_args` param for the sake of the exercise!* :blush:

- Only `--cores` and `--gzip` are hard-coded in `trimgalore/main.nf`

- `ext.args` **is** defined in `trimgalore/main.nf`


<br/>

 
::: callout-tip
### **Challenge**{.unlisted}
Write a custom configuration file named `custom-args.config` that adds `--quality 40` to the script block of the TRIMGALORE module 

:bulb: **Hint:** you may find it helpful to take a copy of the `custom-tools.config` file from the previous exercise!
:::

::: {.callout-caution collapse="true"}
### Solution
```default
// A custom configuration file for specifying external tool arguments

process {
    withName: '.*:FASTQ_FASTQC_UMITOOLS_TRIMGALORE:TRIMGALORE' {   
        ext.args = '--quality 40'
    }
}
```
:::
<br/>

&#x27A4;  Save `custom-args.config` then resume the run, specifying our latest custom config file at `-c` and output directory Lesson-2.4.4:

```default
nextflow run nf-core-rnaseq-3.11.1/workflow/main.nf \
  -profile workshop \
  -c custom-nimbus.config,custom-tools.config,custom-trace.config,custom-args.config \
  -params-file workshop-params.yaml \
  --outdir Lesson-2.4.4 \
  -resume
```
<br/><br/>

:astonished: Pipeline **completed successfully** but <span style="color:#8b0000;"> 2/2 samples failed!</span>

![](../figs/2.4_failed_star.png)
<br/><br/>


&#x27A4;  Investigate the source of the failure:

- Following the advice of the warning message, check the MultiQC report by opening the file `Lesson-2.4.4/multiqc/star_salmon/multiqc_report.html` (with Live Server VS Code extension or taking a local copy)

- Click on the 'WARNING: Fail Trimming Check' on the navigation headings on the left

- Both of our samples '*failed the minimum trimmed reads threshold specified via the `--min_trimmed_reads` parameter, and hence were ignored for the downstream processing steps*'
  - You can confirm this by checking the `Lesson-2.4.4` output directory. Notice that there is no `star_salmon` directory, which is where the output of STAR alignment and Salmon quantification modules are saved 

- Looking at the nf-core/rnaseq parameter documentation, we see [`--min_trimmed_reads` param](https://nf-co.re/rnaseq/3.11.1/parameters#min_trimmed_reads) with default value 10,000. Our samples both had < 5,000 reads. 

![](../figs/2.4_min_trim_param.png)
<br/><br/><br/>


:exclamation: In this example, it is clear that our `ext.args` customisation was successfully applied because of the catastrophic failure it produced. But in less dramatic cases, **how can we confirm that the external argument was actually applied?** :thinking:
<br/><br/>

&#x27A4; Within your MultiQc report, navigate to the section **'nf-core/rnaseq Workflow Summary'**:

- Unlike our custom **options**, **profiles**, and **configs**, the custom quality parameter is **not documented!**
<br/>

Some tools write a handy log, in which case you might view the applied parameters from that file: 

![](../figs/2.4_trimgalore_log.png)
<br/><br/>


In the absence of an informative tool log, you can always rely on `nextflow log` :smiling_face_with_three_hearts:
```default
nextflow log <run_name> -f script | grep -A 10 trim_galore

##
#        trim_galore \
#            --quality 40 \
#            --cores 1 \
#            --gzip \
#            SRR3473989.fastq.gz
##
```
<br/><br/>


&#x27A4;  **Optional final run for the purists at heart :angel:**

- If you would like to conclude today's compute with a successful run, try changing the Trim Galore `--quality` threshold to 30
<br/><br/><br/> 

::: {.callout-important}
## Stay vigilant! 

This lesson highlights the need to **thoroughly check your output to ensure that the intended anlysis has been run and the results are what you require**. 

The message `Pipeline completed successfully` printed to your terminal every time a run completes (and also exit status of zero for individual tasks or cluster jobs if you are running on a cluster) indicates that there were no errors running the pipeline, **not** that your samples have produced the desired output!
:::
<br/><br/>


::: {.callout-note}
### **Key points**
- You can customise container use, resource tracing and mutliqc reports through custom configuration files
- You can apply external tool arguments to an nf-core pipeline using the `ext.args` feature
- You can specify multiple custom configuration files at the Nextflow option `-c` in a comma-delimited list 
- There is no substitute for reading the tool docs when customising your runs!
:::
  